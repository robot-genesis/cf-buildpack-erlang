#!/bin/bash

# Called as:
# ./finalize <build> <cache> <deps> <index>

# build         # The directory for the app
# cache         # Directory location used to store assests during build process
# deps          # Directory used to store dependencies provided by intalled buildpacks
# index         # Nuber representing the ordinal position of the buildpack

# Dependencies are to be stored in {deps}/{index}/
# Expecpt for <deps>/<index>/ all other directories are read-only

# The <cache> directory is persistent for the final buildpack even after upgrade
# <cache> diretories provided to non final buildpacks are cleared if buildpack changes
# -------------------------------------------------------------------------------------

echo "-------> Compiling Erlang applications (finalize)"

set -euo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_INDEX=$4

OTP_VERSION="21.3.8.2"

if [ -f ${BUILD_DIR}/.preferred_otp_version ]; then
  OTP_VERSION=$(cat ${BUILD_DIR}/.preferred_otp_version)
fi

OTP_PACKAGE="OTP-${OTP_VERSION}.tar.gz"

# --------------------

home_dir=$(cd $(dirname $(dirname $0)); pwd)
ERLROOT=${BUILD_DIR}/otp
PROFILE=${BUILD_DIR}/.profile.d

# --------------------


echo "-------> Unpacking Erlang/OTP ${CACHE_DIR}/${OTP_PACKAGE}"
mkdir -p ${ERLROOT}
tar zxf ${CACHE_DIR}/${OTP_PACKAGE} -C ${ERLROOT} --strip-components=1
ln -s ${ERLROOT} /app/otp
${ERLROOT}/Install -minimal /app/otp

echo "ls app"
ls -hal app
echo "ls app/otp"
ls -hal app/otp

PATH=/app/otp/bin:$PATH
export PATH

cd ${BUILD_DIR}

echo "-------> Installing Rebar from buildpack"
cp ${home_dir}/opt/rebar3 ./

echo "-------> Building with Rebar3"

REBAR_CACHE_DIR="${CACHE_DIR}/rebar"
mkdir -p ${REBAR_CACHE_DIR}
export REBAR_CACHE_DIR
./rebar3 release 2>&1 | sed -u 's/^/    /'

if [ ${PIPESTATUS[0]} -ne 0 ]; then
  echo "-------> Build failed"
  exit 1
fi

if [ -f ${home_dir}/opt/otp.sh ]; then
  mkdir -p ${PROFILE}
  cp ${home_dir}/opt/otp.sh ${PROFILE}
fi

echo "-------> Build succeeded"
echo $PATH

exit 0

echo "-------> Extracting Erlang OTP"

## Install Erlang OTP
#sudo dpkg -i ${CACHE_DIR}/${LIB_SCTP}
#sudo dpkg --ignore-depends=libwxbase3.0-0v5,libwxgtk3.0-0v5 -i ${CACHE_DIR}/${OTP_PACKAGE}

ERL_ROOT=${BUILD_DIR}/erlang
PROFILE=${BUILD_DIR}/.profile.d

mkdir -p ${ERL_ROOT}
tar zxf ${CACHE_DIR}/${OTP_PACKAGE} -C ${ERL_ROOT} --strip-components=1

echo "-------> Installing Erlang OTP"
ln -s ${ERL_ROOT} /app/erlang
${ERL_ROOT}/Install -minimal /app/erlang

PATH=/app/erlang/bin:$PATH
export PATH


REBAR_CACHE_DIR="${CACHE_DIR}/rebar"

home_dir=$(cd $(dirname $(dirname $0)); pwd)

echo "BUILD_DIR: ${BUILD_DIR}"
ls ${BUILD_DIR}

echo "HOME_DIR: ${home_dir}"
ls ${home_dir}

echo "CURRENT_DIR"
pwd
ls

echo "-------> Building with rebar3"
cp ${home_dir}/opt/rebar3 ${BUILD_DIR}/
${BUILD_DIR}/rebar3 release 2>&1 | sed -u 's/^/       /'
echo ""

if [ ${PIPESTATUS[0]} -ne 0 ]; then
  echo "-------> Build failed"
  exit 1
fi

echo "-------> Build succeded"
