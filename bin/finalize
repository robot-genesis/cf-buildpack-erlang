#!/bin/bash

# Called as:
# ./finalize <build> <cache> <deps> <index>

# build         # The directory for the app
# cache         # Directory location used to store assests during build process
# deps          # Directory used to store dependencies provided by intalled buildpacks
# index         # Nuber representing the ordinal position of the buildpack

# Dependencies are to be stored in {deps}/{index}/
# Expecpt for <deps>/<index>/ all other directories are read-only

# The <cache> directory is persistent for the final buildpack even after upgrade
# <cache> diretories provided to non final buildpacks are cleared if buildpack changes
# -------------------------------------------------------------------------------------

echo "-------> Compiling Erlang applications (finalize)"

set -euo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_INDEX=$4

OTP_VERSION="21.3.7"

if [ -f ${BUILD_DIR}/.preferred_otp_version ]; then
  OTP_VERSION=$(cat ${BUILD_DIR}/.preferred_otp_version)
fi

OTP_PACKAGE="OTP-${OTP_VERSION}.tar.gz"

# --------------------

BUILDPACK=$(cd $(dirname $(dirname $0)); pwd)
PROFILE=${BUILD_DIR}/.profile.d

PATH=/app/otp/bin:$PATH
export PATH

# --------------------


cd ${BUILD_DIR}

echo "-------> Building with Rebar3"

REBAR_CACHE_DIR="${CACHE_DIR}/rebar"
mkdir -p ${REBAR_CACHE_DIR}
export REBAR_CACHE_DIR

./rebar3 release 2>&1 | sed -u 's/^/    /'

if [ ${PIPESTATUS[0]} -ne 0 ]; then
  echo "-------> Build failed"
  exit 1
fi

if [ -f ${BUILDPACK}/opt/otp.sh ]; then
  mkdir -p ${PROFILE}
  cp ${BUILDPACK}/opt/otp.sh ${PROFILE}
fi

echo "-------> Build succeeded"

exit 0

#echo "-------> Extracting Erlang OTP"

## Install Erlang OTP
#sudo dpkg -i ${CACHE_DIR}/${LIB_SCTP}
#sudo dpkg --ignore-depends=libwxbase3.0-0v5,libwxgtk3.0-0v5 -i ${CACHE_DIR}/${OTP_PACKAGE}
